<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿå·å³¶æ—…è¡Œè¦åŠƒ - åˆ†å¸³ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Noto Sans TC ä»¥æ”¯æ´ä¸­æ–‡ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #212121; /* æ›´æ”¹ç‚ºã€ŒçŸ³çˆºçˆºã€çš„æ·±æ²ˆç«å±±å²©é¡è‰² */
        }
        /* è¼•å¾®æ·¡è—è‰²ä½œç‚ºå¡ç‰‡åˆ†é¡åº•è‰² */
        .card-attraction { background-color: #e6f6ff; }
        .card-restaurant { background-color: #fff0e6; }
        .card-transport { background-color: #e6ffe6; }
        .card-etc { background-color: #f3e6ff; }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ (é¸é…ï¼Œæå‡ App è³ªæ„Ÿ) */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #99cfff; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: #333333; } /* é…åˆæ·±è‰²èƒŒæ™¯æ›´æ–°è»Œé“é¡è‰² */
        
        /* ç¢ºä¿å…§å®¹å€åŸŸå¡«æ»¿å±å¹•é«˜åº¦ */
        #content-container {
            height: calc(100vh - 64px - 64px); /* æ¸›å» header å’Œ tabs çš„é«˜åº¦ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
    <!-- é…ç½® Tailwind CSS ä½¿ç”¨ Inter å­—ä½“å’Œåœ†è§’ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#64b5f6',
                        'secondary-light': '#bbdefb',
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen">

    <!-- Firebase æ¨¡çµ„è¼‰å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase å…¨åŸŸè®Šæ•¸
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        let app, db, auth;
        
        // è¡Œå‰æº–å‚™æ¸…å–®
        const initialChecklist = {
            'è­·ç…§ã€æ©Ÿç¥¨ã€é è¨‚ç¢ºèªå–®': false,
            'ç•¶åœ°è²¨å¹£ (éŸ“å…ƒ) åŠæµ·å¤–ä¿¡ç”¨å¡': false,
            'è½‰æ›æ’é ­ (éŸ“æ¨™) èˆ‡è¡Œå‹•é›»æº': false,
            'æ—…éŠä¿éšªå–®å‰¯æœ¬èˆ‡ç·Šæ€¥è¯çµ¡è³‡è¨Š': false,
            'å¸¸å‚™è—¥å“ã€å€‹äººè­·ç†ç”¨å“': false,
            'é˜²æ°´/ä¿æš–è¡£ç‰© (æ¿Ÿå·å³¶12æœˆè¼ƒå†·)': false,
            'åœ‹éš›é§•ç…§ã€è­·ç…§ã€é§•ç…§åŸä»¶ (ç§Ÿè»Šç”¨)': false,
            'é‡è¦æ–‡ä»¶é›»å­å‚™ä»½ï¼ˆé›²ç«¯ï¼‰': false,
            'é è¼‰éŸ“åœ‹åœ°åœ– App (KakaoMap/Naver Map)': false, // æ–°å¢ï¼šå°èˆª App æé†’
        };

        window.state = {
            userId: null,
            isAuthReady: false,
            activePage: 'prep', 
            expenses: [],
            itineraryData: null,
            guideCache: {},
            checklist: initialChecklist 
        };

        setLogLevel('debug'); // é–‹å•Ÿ Firestore åµéŒ¯æ—¥èªŒ

        // --- Firebase åˆå§‹åŒ–èˆ‡èº«ä»½é©—è­‰ ---
        const initFirebase = async () => {
            if (Object.keys(window.firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Using mocked data for expenses.");
                document.getElementById('auth-status').textContent = "ï¼ˆè­¦å‘Šï¼šè³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œç„¡æ³•å„²å­˜è²»ç”¨ï¼‰";
                document.getElementById('auth-status').classList.remove('hidden');
                return;
            }

            try {
                app = initializeApp(window.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                window.db = db; // è®“ä¸» JS ç¨‹å¼ç¢¼å¯ä»¥å­˜å– db

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        window.state.userId = user.uid;
                        console.log("User authenticated:", user.uid);
                    } else {
                        try {
                            const anonymousUser = await signInAnonymously(auth);
                            window.state.userId = anonymousUser.user.uid;
                            console.log("Signed in anonymously:", window.state.userId);
                        } catch (error) {
                            console.error("Anonymous sign in failed:", error);
                        }
                    }
                    window.state.isAuthReady = true;
                    window.initAppAfterAuth();
                });

                if (window.initialAuthToken) {
                    await signInWithCustomToken(auth, window.initialAuthToken);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // è²»ç”¨ç›£è½å™¨ (ä¸è®Š)
        window.setupExpenseListener = () => {
            const userId = window.state.userId;
            const appId = window.appId;
            if (!userId || !db) {
                console.warn("Firestore not ready or user not logged in.");
                return;
            }

            // ç§äººæ•¸æ“šè·¯å¾‘ï¼š/artifacts/{appId}/users/{userId}/expenses
            const expensesRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
            const q = query(expensesRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                window.state.expenses = expenses;
                // åªæœ‰åœ¨åˆ†å¸³é é¢æ™‚æ‰é‡æ–°æ¸²æŸ“æ¸…å–®å’Œç¸½çµ
                if (window.state.activePage === 'expenses') {
                    window.renderExpensePage();
                }
            }, (error) => {
                console.error("Error listening to expenses:", error);
            });
        };

        // è²»ç”¨å„²å­˜åŠŸèƒ½ (ä¸è®Š)
        window.saveExpense = async (expense) => {
            if (!window.state.userId || !db) {
                // ä½¿ç”¨è‡ªè¨‚è¨Šæ¯æ¡†ä»£æ›¿ alert
                console.error("éŒ¯èª¤ï¼šèº«ä»½é©—è­‰æœªå®Œæˆï¼Œç„¡æ³•å„²å­˜è²»ç”¨ã€‚");
                return false;
            }
            try {
                const expensesRef = collection(db, `artifacts/${window.appId}/users/${window.state.userId}/expenses`);
                await addDoc(expensesRef, {
                    ...expense,
                    timestamp: serverTimestamp() // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“æˆ³
                });
                return true;
            } catch (error) {
                console.error("Error adding document:", error);
                // ä½¿ç”¨è‡ªè¨‚è¨Šæ¯æ¡†ä»£æ›¿ alert
                return false;
            }
        };

        // è²»ç”¨åˆªé™¤åŠŸèƒ½ (ä¸è®Š)
        window.deleteExpense = async (id) => {
            if (!window.state.userId || !db) {
                // ä½¿ç”¨è‡ªè¨‚è¨Šæ¯æ¡†ä»£æ›¿ alert
                console.error("éŒ¯èª¤ï¼šèº«ä»½é©—è­‰æœªå®Œæˆï¼Œç„¡æ³•åˆªé™¤è²»ç”¨ã€‚");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${window.appId}/users/${window.state.userId}/expenses`, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document:", error);
                // ä½¿ç”¨è‡ªè¨‚è¨Šæ¯æ¡†ä»£æ›¿ alert
            }
        };

        initFirebase();
    </script>


    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼ä»‹é¢ -->
    <div id="app" class="flex flex-col h-screen max-w-lg mx-auto bg-white shadow-xl">

        <!-- Header: æ¨™é¡Œ (å·²é‚„åŸç‚ºé£›æ©Ÿåœ–ç¤º) -->
        <header class="bg-primary-blue text-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-xl font-bold">
                <!-- é£›æ©Ÿ Emoji (å·²é‚„åŸ) -->
                <span class="text-xl mr-2">âœˆï¸</span>
                <span style="font-size: 1.5rem; font-weight: 700;">æ¿Ÿå·å³¶æ—…è¡Œ</span>
            </h1>
            <div id="user-id-display" class="text-xs bg-white text-primary-blue px-2 py-1 rounded-full opacity-80">
                ä½¿ç”¨è€…ID: è¼‰å…¥ä¸­...
            </div>
        </header>

        <!-- èº«ä»½é©—è­‰ç‹€æ…‹é¡¯ç¤º (é™¤éŒ¯ç”¨) -->
        <div id="auth-status" class="text-xs text-center p-1 bg-yellow-100 text-yellow-800 hidden">Loading...</div>

        <!-- Tab Bar for Days and Expenses -->
        <nav class="bg-white shadow-inner flex justify-around p-2 sticky top-16 z-10" id="day-tabs">
            <!-- Tabs will be rendered here by JS -->
        </nav>

        <!-- Main Content Area -->
        <main id="content-container" class="p-4 space-y-4">
            <!-- Content will be rendered here based on activePage -->
        </main>

    </div>

    <script>
        // --- æ ¸å¿ƒè¡Œç¨‹æ•¸æ“šçµæ§‹ (å·²å…¨é¢æ›´æ–°ï¼Œæ–°å¢ Day 2 & Day 3 åº§æ¨™) ---
        const itineraryData = {
            day1: {
                date: '12/6',
                title: 'Day 1å¤© (12/6) - è¥¿éƒ¨: çœ‹æµ· & è³ªæ„Ÿé¸ç‰©',
                weather: { emoji: 'â˜€ï¸', text: 'æ™´æœ—', temp: '15Â°C', location: 'æ¶¯æœˆ/ç¿°æ—' },
                locations: [
                    { time: '06:05', name: 'æ¿Ÿå·æ©Ÿå ´', type: 'äº¤é€š', category: 'transport', coords: { lat: 33.5113, lng: 126.4933 } }, 
                    { time: '08:30', name: 'æ˜Ÿå·´å…‹ æ¶¯æœˆåº—', type: 'é¤å»³', category: 'restaurant', note: 'å–é™å®šç‰¹èª¿', coords: { lat: 33.4682, lng: 126.3105 } },
                    { time: '10:30', name: 'Noraba æµ·é®®æ‹‰éºµ', type: 'é¤å»³', category: 'restaurant', note: 'æˆ¶å¤–çœ‹æµ·åƒéºµ', coords: { lat: 33.4735, lng: 126.3142 } },
                    { time: '12:30', name: 'Mood & Slo-mo', type: 'æ™¯é»', category: 'attraction', note: 'ç¿°æ—è³ªæ„Ÿé¸ç‰©åº—é€›è¡—', coords: { lat: 33.4110, lng: 126.3180 } },
                    { time: '14:30', name: 'æŒ¾æ‰æµ·æ°´æµ´å ´', type: 'æ™¯é»', category: 'attraction', note: 'æœå‡æµ·æ‹ç…§', coords: { lat: 33.3916, lng: 126.2366 } },
                    { time: '16:00', name: 'Hello Kitty Island', type: 'æ™¯é»', category: 'attraction', coords: { lat: 33.3031, lng: 126.4718 } },
                    { time: '18:30', name: 'ç†Ÿæˆåˆ° æ¶¯æœˆåº—', type: 'é¤å»³', category: 'restaurant', note: 'è¨˜å¾—é ç´„ï¼', coords: { lat: 33.4682, lng: 126.3105 } },
                    { time: '20:30', name: 'Poniente æ°‘å®¿', type: 'ä½å®¿', category: 'etc', note: 'è¾¦ç†å…¥ä½æ‰‹çºŒ', coords: { lat: 33.4750, lng: 126.3200 } },
                    { time: 'å®µå¤œ', name: 'Puradak ç‚¸é›', type: 'ç¾é£Ÿ', category: 'restaurant', note: 'å¿…é»: ç´«èœæµ·è‹”å£å‘³', coords: { lat: 33.4750, lng: 126.3200 } } // æ–°å¢åº§æ¨™
                ]
            },
            day2: {
                date: '12/7',
                title: 'Day 2å¤© (12/7) - å—éƒ¨&å¸‚å€ï¼šå®¤å…§èº²é›¨èˆ‡æ–‡å‰µæ¢ç´¢',
                weather: { emoji: 'ğŸŒ§ï¸', text: 'é å ±ä¸‹é›¨', temp: '10Â°C', location: 'è¥¿æ­¸æµ¦/æ¿Ÿå·å¸‚å€' },
                locations: [
                    // *** æ©˜èŠ±é–¨æ¨“ï¼šåœ°å€å’Œå‚™è¨»å·²æ›´æ–° ***
                    { 
                        time: '10:30', 
                        name: 'æ©˜èŠ±é–¨æ¨“', 
                        type: 'é¤å»³', 
                        category: 'restaurant', 
                        note: 'è¶…ç¾æ©˜å­çª—æ™¯å’–å•¡ã€‚åœ°å€: 34 Ieodo-ro 1027beon-gil, Seogwipo-si, Jeju-do, å—éŸ“', 
                        coords: { lat: 33.2505, lng: 126.5685 }, 
                        address: '34 Ieodo-ro 1027beon-gil, Seogwipo-si, Jeju-do, å—éŸ“' 
                    },
                    { time: '12:30', name: 'è¥¿æ­¸æµ¦æ¯æ—¥å¶ä¾†å¸‚å ´', type: 'ç¾é£Ÿ', category: 'attraction', note: 'è€å¥¶å¥¶æ©˜å­éº»ç³¬', coords: { lat: 33.2483, lng: 126.5658 } },
                    { time: '15:00', name: 'æ¿Ÿå·å¸‚å€æ–‡é’æ•£æ­¥', type: 'æ™¯é»', category: 'attraction', note: 'åŒ…å« Classic Moongusa, The Islander, Playworks', coords: { lat: 33.5135, lng: 126.5298 } },
                    { time: '16:30', name: 'Mochiron & Eggultart', type: 'ç¾é£Ÿ', category: 'restaurant', note: 'é”å…‹ç“¦èŒ²èˆ‡è‰è“ç‰›å¥¶', coords: { lat: 33.5090, lng: 126.5310 } },
                    { time: '18:00', name: 'æ¿Ÿå·æ±é–€å¸‚å ´', type: 'ç¾é£Ÿ', category: 'attraction', note: 'å¤œå¸‚å°åƒ', coords: { lat: 33.5141, lng: 126.5348 } },
                    { time: '19:30', name: 'æ¨‚å¤©è¶…å¸‚ æ¿Ÿå·åº—', type: 'è³¼ç‰©', category: 'etc', note: 'é›¶é£Ÿæ³¡éºµå¤§è£œè²¨', coords: { lat: 33.5061, lng: 126.5283 } }
                ]
            },
            day3: {
                date: '12/8',
                title: 'Day 3å¤© (12/8) - æ±éƒ¨: æˆ¶å¤–æ‹ç…§æ—¥',
                weather: { emoji: 'ğŸŒ¤ï¸', text: 'å¤©æ°£è½‰æ™´', temp: '18Â°C', location: 'åŸå±±æ—¥å‡ºå³°' },
                locations: [
                    // æ–°å¢åº§æ¨™
                    { time: '09:00', name: 'London Bagel & å¤¢ç‚­', type: 'é¤å»³', category: 'restaurant', coords: { lat: 33.4795, lng: 126.5925 } },
                    { time: '12:00', name: 'Dalmeunggot', type: 'æ™¯é»', category: 'attraction', note: 'æœˆæ±€é‡Œç¶ è‰²å±‹é ‚å°åº—', coords: { lat: 33.5570, lng: 126.7900 } },
                    { time: '13:30', name: 'Snoopy Garden ìŠ¤ëˆ„í”¼ê°€ë“ ', type: 'æ™¯é»', category: 'attraction', note: 'æˆ¶å¤–èŠ±åœ’æ‹ç…§', coords: { lat: 33.4262, lng: 126.7844 } },
                    { time: '16:00', name: 'Audrant Bakery', type: 'ç¾é£Ÿ', category: 'restaurant', note: 'å¤§è’œéºµåŒ…', coords: { lat: 33.4900, lng: 126.8300 } },
                    { time: '17:00', name: 'åŸå±±æ—¥å‡ºå³°', type: 'æ™¯é»', category: 'attraction', note: 'çˆ¬å±±çœ‹æ—¥è½', coords: { lat: 33.4628, lng: 126.9377 } },
                    { time: '18:30', name: 'ä¸‰ä»£æµ·å¥³ä¹‹å®¶', type: 'é¤å»³', category: 'restaurant', note: 'æµ·é®®åˆ€å‰Šéºµ', coords: { lat: 33.4735, lng: 126.9360 } }
                ]
            },
            day4: {
                date: '12/9',
                title: 'Day 4å¤© (12/9) - è³¦æ­¸',
                weather: { emoji: 'ğŸŒ¥ï¸', text: 'å¤šé›²', temp: '13Â°C', location: 'æ¿Ÿå·æ©Ÿå ´' },
                locations: [
                    { time: '13:00', name: 'æ¿Ÿå·åœ‹éš›æ©Ÿå ´', type: 'äº¤é€š', category: 'transport', coords: { lat: 33.5113, lng: 126.4933 } }
                ]
            }
        };
        
        // --- å…¨å±€å¸¸æ•¸ ---
        const KRW_TO_TWD_RATE = 0.024; // 1 KRW â‰ˆ 0.024 TWD (æ¨¡æ“¬åŒ¯ç‡)
        const USERS = ['Karen', 'Zuzu', 'Yuki', 'Mindy'];


        // --- å…¨å±€ç‹€æ…‹èˆ‡åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            window.state.itineraryData = itineraryData;
        });

        window.initAppAfterAuth = () => {
            document.getElementById('auth-status').classList.add('hidden');
            document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€…ID: ${window.state.userId.substring(0, 8)}...`;
            renderDayTabs();
            // åˆå§‹æ¸²æŸ“ç‚º 'prep'
            window.renderAppContent(window.state.activePage);
            
            // è²»ç”¨åŠŸèƒ½å•Ÿå‹•
            if (window.db) {
                window.setupExpenseListener();
            }
        };


        // --- æ ¸å¿ƒ UI æ¸²æŸ“åŠŸèƒ½ ---

        // æ¸²æŸ“ä¸»å…§å®¹ï¼ˆæ ¹æ“šç•¶å‰åˆ†é ï¼‰
        window.renderAppContent = (pageKey) => {
            const contentContainer = document.getElementById('content-container');
            contentContainer.scrollTop = 0; // åˆ‡æ›åˆ†é æ™‚æ»¾å‹•åˆ°é ‚éƒ¨
            
            if (pageKey === 'expenses') {
                window.renderExpensePage();
            } else if (pageKey === 'prep') { // æ–°å¢ è¡Œå‰æº–å‚™ é é¢æ¸²æŸ“
                window.renderPrepPage();
            } else if (itineraryData[pageKey]) {
                window.renderDailyItinerary(pageKey);
            }
        };

        // æ¸²æŸ“é ‚éƒ¨æ¨™ç±¤
        function renderDayTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            tabsContainer.innerHTML = '';
            
            // ç¢ºä¿ 'prep' åœ¨è¡Œç¨‹ä¹‹å‰
            const pages = ['prep', ...Object.keys(itineraryData), 'expenses'];

            pages.forEach(pageKey => {
                const isExpense = pageKey === 'expenses';
                const isPrep = pageKey === 'prep';
                
                let buttonText;
                if (isPrep) {
                    buttonText = 'è¡Œå‰æº–å‚™ ğŸ“';
                } else if (isExpense) {
                    buttonText = 'åˆ†å¸³/çµç®— ğŸ’°'; 
                } else {
                    buttonText = `${pageKey.charAt(0).toUpperCase() + pageKey.slice(1)}å¤©`;
                }

                const isActive = pageKey === window.state.activePage;
                const button = document.createElement('button');

                button.textContent = buttonText;
                button.className = `py-2 px-3 rounded-full font-medium transition-all duration-200 text-sm ${isActive ? 'bg-primary-blue text-white shadow-md' : 'text-gray-600 hover:bg-secondary-light'}`;
                
                button.onclick = () => {
                    window.state.activePage = pageKey;
                    renderDayTabs();
                    window.renderAppContent(pageKey);
                };
                tabsContainer.appendChild(button);
            });
        }

        // æ¸²æŸ“æ¯æ—¥è¡Œç¨‹ (å·²ç§»é™¤å€åŸŸç¸½è¦½åœ°åœ–)
        window.renderDailyItinerary = (dayKey) => {
            const dayData = itineraryData[dayKey];
            const contentContainer = document.getElementById('content-container');
            contentContainer.innerHTML = '';
            
            // 1. æ¯æ—¥å¤©æ°£/æ¨™é¡Œå¡ç‰‡
            contentContainer.innerHTML += createWeatherCard(dayData);
            
            // 2. è¡Œç¨‹å¡ç‰‡
            dayData.locations.forEach((location, index) => {
                contentContainer.innerHTML += createItineraryCard(dayKey, index, location);
            });
        }

        // --- è¡Œå‰æº–å‚™èˆ‡æ³¨æ„äº‹é … æ¸²æŸ“ (æ–°) ---

        /**
         * Toggles the checked status of a checklist item.
         * ç”±æ–¼æ²’æœ‰ä½¿ç”¨ Firestore å„²å­˜ checklist ç‹€æ…‹ï¼Œæˆ‘å€‘ç›´æ¥æ›´æ–° window.state
         * @param {string} itemKey - The key (text) of the item to toggle.
         */
        window.toggleChecklistItem = (itemKey) => {
            window.state.checklist[itemKey] = !window.state.checklist[itemKey];
            if (window.state.activePage === 'prep') {
                window.renderPrepPage(); // é‡æ–°æ¸²æŸ“é é¢ä»¥é¡¯ç¤ºæ›´æ–°
            }
        }

        /**
         * Renders the Checklist (è¡Œå‰æº–å‚™åŠæ³¨æ„äº‹é …) page.
         */
        window.renderPrepPage = () => {
            const checklist = window.state.checklist;
            const contentContainer = document.getElementById('content-container');

            let checklistHTML = '';
            for (const [text, checked] of Object.entries(checklist)) {
                // SVG for the checkbox icon (Lucide icons: Square and CheckSquare)
                const iconSVG = checked
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green-600 mr-3"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-400 mr-3"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>`;

                // ä½¿ç”¨ window.toggleChecklistItem ç¢ºä¿å‡½æ•¸å¯å­˜å–
                checklistHTML += `
                    <li onclick="window.toggleChecklistItem('${text}')" class="flex items-center p-4 mb-3 bg-white rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-150 ease-in-out border ${checked ? 'border-green-400' : 'border-gray-200'}">
                        ${iconSVG}
                        <span class="text-lg font-medium ${checked ? 'line-through text-gray-500' : 'text-gray-800'}">${text}</span>
                    </li>
                `;
            }

            // HTML content for the entire preparation page
            contentContainer.innerHTML = `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-white border-b-4 border-blue-500 pb-2">ğŸ“ è¡Œå‰æº–å‚™åŠæ³¨æ„äº‹é …</h2>

                    <!-- è¡Œå‰æº–å‚™ Checklist Section -->
                    <section>
                        <h3 class="text-2xl font-bold text-blue-400 mb-4">âœ… è¡Œå‰æº–å‚™æ¸…å–® (é»æ“Šé …ç›®é€²è¡Œå‹¾é¸)</h3>
                        <ul class="list-none p-0">
                            ${checklistHTML}
                        </ul>
                    </section>

                    <!-- æ³¨æ„äº‹é … Precautions Section -->
                    <section>
                        <h3 class="text-2xl font-bold text-red-400 mb-4 mt-6">âš ï¸ æ¿Ÿå·å³¶æ—…éŠæ³¨æ„äº‹é … (12æœˆ)</h3>
                        <div class="bg-red-50 p-6 rounded-xl shadow-inner space-y-3">
                            <p class="text-gray-800">1. **ä¿æš–èˆ‡é˜²é¢¨:** æ¿Ÿå·å³¶12æœˆé¢¨å¤§ä¸”æµ·é‚Šå¯’å†·ï¼Œå‹™å¿…æº–å‚™åšå¤–å¥—ã€åœå·¾ã€æ‰‹å¥—å’Œå¸½å­ï¼Œå¤šå±¤æ¬¡ç©¿æ­ã€‚</p>
                            <p class="text-gray-800">2. **ç§Ÿè»Šé§•é§›:** éŸ“åœ‹é å³è¡Œé§›ï¼Œæ¿Ÿå·å³¶éƒ¨åˆ†è·¯æ®µæœ‰å±±å¡æˆ–å½é“ã€‚è«‹å°å¿ƒé§•é§›ï¼Œç‰¹åˆ¥ç•™æ„è·¯é‚Šåœé çš„æµ·å¥³æ”¤è²©ã€‚</p>
                            <p class="text-gray-800">3. **é¤å»³é ç´„:** åƒã€Œç†Ÿæˆåˆ°ã€é€™é¡ç†±é–€é»‘è±¬è‚‰é¤å»³ï¼Œå¼·çƒˆå»ºè­°æå‰é€éé›»è©±æˆ–éŸ“åœ‹Appï¼ˆå¦‚ Catch Tableï¼‰é ç´„ã€‚</p>
                            <p class="text-gray-800">4. **æ©˜å­æ¡è³¼:** 12æœˆæ˜¯æ©˜å­ç››ç”¢æœŸã€‚åœ¨å¸‚å ´è³¼è²·æ™‚ï¼Œæ³¨æ„è¾¨åˆ¥å“ç¨®å’Œæ–°é®®åº¦ï¼Œå¯ä»¥é©åº¦è­°åƒ¹ã€‚</p>
                            <p class="text-gray-800">5. **ç·Šæ€¥è¯çµ¡:** éŸ“åœ‹ç·Šæ€¥é›»è©±ï¼šè­¦å¯Ÿ 112ï¼Œæ¶ˆé˜²/æ•‘è­·è»Š 119ã€‚å°‡é£¯åº—å’Œç§Ÿè»Šå…¬å¸é›»è©±å„²å­˜ã€‚</p>
                            <p class="text-gray-800 font-bold">6. **<span class="text-red-600">å°èˆª App (æ¥µé‡è¦):</span>** Google Maps åœ¨éŸ“åœ‹ç„¡æ³•æä¾›å¯é çš„é§•è»Š/å¤§çœ¾é‹è¼¸å°èˆªã€‚è«‹å‹™å¿…<span class="underline">é å…ˆä¸‹è¼‰ä¸¦ç†Ÿæ‚‰</span> **KakaoMap** æˆ– **Naver Map**ï¼Œé€™å°æ‚¨çš„è‡ªé§•è¡Œç¨‹è‡³é—œé‡è¦ï¼</p>
                        </div>
                    </section>
                </div>
            `;
             // æ›´æ–°äº†æ¨™é¡Œé¡è‰²ï¼Œç¢ºä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¯è¦‹
            const prepTitles = contentContainer.querySelectorAll('h2, h3');
            prepTitles.forEach(el => {
                if (el.tagName === 'H2') el.classList.remove('text-gray-900');
                if (el.tagName === 'H3' && el.classList.contains('text-blue-700')) {
                    el.classList.remove('text-blue-700');
                    el.classList.add('text-blue-400');
                }
                if (el.tagName === 'H3' && el.classList.contains('text-red-700')) {
                    el.classList.remove('text-red-700');
                    el.classList.add('text-red-400');
                }
            });
        }


        // --- è¡Œç¨‹è¼”åŠ©æ¸²æŸ“å‡½æ•¸ (å·²æ›´æ–°å°èˆªæŒ‰éˆ•) ---
        function createWeatherCard(dayData) {
            return `
                <div class="bg-gradient-to-r from-primary-blue to-blue-300 text-white p-5 rounded-xl shadow-lg mb-4">
                    <h2 class="text-2xl font-bold mb-1">${dayData.title}</h2>
                    <p class="text-sm font-light">${dayData.weather.location} | ${dayData.weather.date}</p>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center">
                            <span class="text-5xl mr-3">${dayData.weather.emoji}</span>
                            <div>
                                <p class="text-3xl font-bold">${dayData.weather.temp}</p>
                                <p class="text-sm">${dayData.weather.text}</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="text-xs font-semibold">ä»Šæ—¥å°è¦½æé†’ï¼š</p>
                            <p class="text-sm">${dayData.weather.emoji === 'ğŸŒ§ï¸' ? 'å»ºè­°å®¤å…§è¡Œç¨‹ï¼Œè«‹æ”œå¸¶é›¨å…·ï¼' : 'æˆ¶å¤–æ”å½±æ—¥ï¼Œé˜²æ›¬æº–å‚™ï¼'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createItineraryCard(dayKey, index, location) {
            const categoryMap = {
                'attraction': 'æ™¯é»', 'restaurant': 'é¤å»³', 'transport': 'äº¤é€š', 'etc': 'å…¶ä»–',
                'ç¾é£Ÿ': 'é¤å»³', 'å’–å•¡å»³': 'é¤å»³', 'ä½å®¿': 'å…¶ä»–', 'è³¼ç‰©': 'å…¶ä»–'
            };
            const category = location.category || location.type || 'etc';
            const categoryLabel = categoryMap[category] || categoryMap[location.type] || 'å…¶ä»–';
            const bgColorClass = `card-${category}`;
            const key = `${dayKey}-${index}`;
            const isGuideLoaded = window.state.guideCache[key];

            // KakaoMap å°èˆª/æœç´¢ä½¿ç”¨åç¨± (åœ¨éŸ“åœ‹æœ€æº–ç¢º)
            const encodedName = encodeURIComponent(location.name);
            // Google Map æœç´¢å„ªå…ˆä½¿ç”¨åœ°å€ (å¦‚æœå­˜åœ¨)ï¼Œå¦å‰‡ä½¿ç”¨åç¨±
            const encodedGoogleQuery = encodeURIComponent(location.address || location.name);


            return `
                <div class="bg-white p-4 rounded-xl shadow-md overflow-hidden">
                    <div class="flex items-start">
                        <span class="text-lg font-bold text-gray-500 w-16 flex-shrink-0">${location.time}</span>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-semibold text-gray-800">${location.name}</h4>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${bgColorClass} border border-blue-200 text-primary-blue">${categoryLabel}</span>
                            </div>
                            ${location.note ? `<p class="text-sm text-gray-600 mt-1">${location.note}</p>` : ''}
                            
                            <!-- å°éŠè·è²¬/æ•…äº‹å€å¡Š -->
                            <div id="guide-${key}" class="mt-3 space-y-2">
                                ${isGuideLoaded ? isGuideLoaded : '<div class="text-sm text-gray-500 italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç²å–å°è¦½è³‡è¨Š...</div>'}
                            </div>

                            <div class="flex space-x-2 mt-4">
                                <!-- å°éŠè·è²¬æŒ‰éˆ• -->
                                <button onclick="fetchGuideDetails('${dayKey}', ${index})" 
                                        class="flex-1 bg-secondary-light text-primary-blue text-sm font-semibold py-2 rounded-full hover:bg-blue-200 transition duration-150">
                                    ${isGuideLoaded ? 'é‡æ–°åˆ†æ/æ”¶èµ·' : 'å°éŠè·è²¬ ğŸ“œ'}
                                </button>
                                
                                <!-- å°èˆª/æœç´¢æŒ‰éˆ•çµ„ (åƒ…é™æœ‰åº§æ¨™çš„) -->
                                ${location.coords ? `
                                    <!-- 1. KakaoMap å°èˆª (ç¾æ”¹ç‚ºåç¨±æœç´¢) -->
                                    <a href="https://map.kakao.com/link/search/${encodedName}" target="_blank"
                                       class="flex-1 bg-yellow-500 text-gray-900 text-sm font-semibold py-2 rounded-full text-center hover:bg-yellow-600 transition duration-150 flex items-center justify-center">
                                        <!-- Map Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m10.606-10.606l-4.243 4.243m0 0L9.414 7.414m-1.414 4.243l4.243 4.243m0 0L17.657 16.657m0 0L13.414 20.9m4.243-4.243a8 8 0 10-10.606 0" />
                                        </svg>
                                        KakaoMap å°èˆª
                                    </a>
                                    <!-- 2. Google Map æœç´¢ (å„ªå…ˆä½¿ç”¨åœ°å€) -->
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodedGoogleQuery}" target="_blank"
                                       class="flex-1 bg-blue-100 text-primary-blue text-sm font-semibold py-2 rounded-full text-center hover:bg-blue-200 transition duration-150 flex items-center justify-center">
                                        <!-- Search Icon (Magnifying Glass) -->
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                        Google Map æœç´¢
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- å°éŠè·è²¬ (LLM) æ¨¡æ“¬åŠŸèƒ½ (å·²æ›´æ–°æ±é–€å¸‚å ´å’Œå²åŠªæ¯”åšç‰©é¤¨çš„å…§å®¹) ---
        function getMockGuideContent(locationName) {
            const nameToContent = {
                'æ¿Ÿå·æ©Ÿå ´': {
                    guide: `OK ç§Ÿè»Šå…¬å¸é€šå¸¸æä¾›æ¥é§æœå‹™å¾€è¿”æ©Ÿå ´å’Œç§Ÿè»Šé»ã€‚è«‹åœ¨æŠµé”æ©Ÿå ´å¾Œï¼Œæ ¹æ“šæŒ‡ç¤ºå‰å¾€æŒ‡å®šæ¥é§è»Šä¹˜è»Šé»ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">é‡è¦æé†’</span>ï¼šå–è»Šæ‰‹çºŒéœ€è¦æ™‚é–“ï¼Œè«‹é ç•™å……è¶³æ™‚é–“ã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…å‚™æ–‡ä»¶</span>ï¼šåœ‹éš›é§•ç…§ã€è­·ç…§ã€é§•ç…§åŸä»¶ã€‚</li>
                        </ul>`,
                    key: 'OK-CarRental-2025'
                },
                'æ˜Ÿå·´å…‹ æ¶¯æœˆåº—': {
                    guide: `æ¶¯æœˆæµ·å²¸ç·šçš„æ˜Ÿå·´å…‹é€šå¸¸æ“æœ‰çµ•ä½³æµ·æ™¯ï¼é€™æ˜¯é–‹å§‹ç¾å¥½ä¸€å¤©çš„å¥½åœ°æ–¹ã€‚è¨˜å¾—è©¦è©¦æ¿Ÿå·å³¶é™å®šçš„é£²å“æˆ–ç³•é»ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…è©¦</span>ï¼šæ¿Ÿå·é»‘èŠéº»æ‹¿éµã€æ¿Ÿå·é™å®šè›‹ç³•ã€‚</li>
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">æ‹ç…§å»ºè­°</span>ï¼šé¸æ“‡é çª—ä½ç½®ï¼Œæ‹ä¸‹æµ·æ™¯èˆ‡å’–å•¡çš„åˆå½±ã€‚</li>
                        </ul>`,
                    key: 'Starbucks-Aewol-2025'
                },
                'Noraba æµ·é®®æ‹‰éºµ': {
                    guide: `è«¾æ‹‰å·´ (Noraba) æ˜¯ä¸€å®¶ä½æ–¼æµ·å²¸é‚Šçš„è¶…äººæ°£æµ·é®®æ‹‰éºµåº—ï¼Œä»¥å…¶çµ•ä½³çš„æµ·æ™¯è¦–é‡å’Œæ–°é®®æµ·ç”¢èåã€‚å»ºè­°åœ¨åˆé¤æ™‚é–“å‰æŠµé”ï¼Œé¿é–‹æ’éšŠäººæ½®ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…åƒç¾é£Ÿ</span>ï¼šæ‹›ç‰Œæµ·é®®æ‹‰éºµï¼Œæ¹¯é ­æ¿ƒéƒã€æµ·ç”¢æ–°é®®ã€‚</li>
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é»èœå–®</span>ï¼šé™¤äº†æ‹‰éºµï¼Œçƒ¤é®‘é­šä¹Ÿæ˜¯ç†±é–€é¸é …ã€‚</li>
                        </ul>`,
                    key: 'Noraba-Ramen-2025'
                },
                'Mood & Slo-mo': {
                    guide: `é€™æ˜¯ä¸€å®¶å……æ»¿è³ªæ„Ÿèˆ‡è¨­è¨ˆæ„Ÿçš„é¸ç‰©åº—ï¼Œæä¾›æ¿Ÿå·å³¶è—è¡“å®¶å‰µä½œçš„ç¨ç‰¹å•†å“å’Œç´€å¿µå“ã€‚éå¸¸é©åˆå–œæ­¡æ–‡å‰µå’Œè³ªæ„Ÿç”Ÿæ´»ç”¨å“çš„æ‚¨ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é€›</span>ï¼šæ¿Ÿå·å³¶ç‰¹è‰²é¦™æ°›ã€æ‰‹å·¥é£¾å“ã€è¨­è¨ˆæ–‡å…·ã€‚</li>
                            <li><span class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded-full">è³¼ç‰©å»ºè­°</span>ï¼šåœ¨é€™è£¡å¯ä»¥æ‰¾åˆ°åˆ¥è™•æ²’æœ‰çš„ç¨ç‰¹ä¼´æ‰‹ç¦®ã€‚</li>
                        </ul>`,
                    key: 'Mood-Slo-mo-2025'
                },
                'æŒ¾æ‰æµ·æ°´æµ´å ´': {
                    guide: `æŒ¾æ‰æµ·æ°´æµ´å ´å› å…¶æ¸…æ¾ˆè¦‹åº•ã€å®›å¦‚æœå‡èˆ¬çš„æµ·æ°´è€Œèåï¼Œå°é¢å°±æ˜¯é£›æšå³¶ (Biyangdo)ã€‚å®ƒè¢«èªç‚ºæ˜¯æ¿Ÿå·å³¶æœ€ç¾çš„æµ·ç˜ä¹‹ä¸€ï¼Œéå¸¸é©åˆæ‹ç…§ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…æ‹è§’åº¦</span>ï¼šä»¥é£›æšå³¶ç‚ºèƒŒæ™¯ï¼Œæ‹æ”é€æ˜æµ·æ°´çš„å±¤æ¬¡æ„Ÿã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…å‚™ç‰©å“</span>ï¼šé˜²æ›¬éœœã€å¤ªé™½çœ¼é¡ï¼Œä»¥åŠä¸€æ¢ç¾éº—çš„çµ²å·¾ã€‚</li>
                        </ul>`,
                    key: 'Hyeopjae-Beach-Guide-2025'
                },
                'Hello Kitty Island': {
                    guide: `Hello Kitty Island æ˜¯å…¨çƒå”¯ä¸€ä»¥ Hello Kitty ç‚ºä¸»é¡Œçš„åšç‰©é¤¨ã€‚é€™è£¡æœ‰è±å¯Œçš„å±•è¦½ã€æ‹ç…§å€å’Œå‘¨é‚Šå•†å“åº—ï¼Œéå¸¸é©åˆç«¥å¿ƒæœªæ³¯çš„æ‚¨ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-pink-100 text-pink-800 text-xs font-bold px-2 py-0.5 rounded-full">å°‘å¥³å¿ƒçˆ†ç™¼</span>ï¼šå„å€‹ä¸»é¡Œæˆ¿å’Œå¤¢å¹»ä½ˆæ™¯éƒ½æ˜¯æ‹ç…§æ‰“å¡é»ï¼</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">é™å®šå•†å“</span>ï¼šè¨˜å¾—åœ¨ç¦®å“åº—å°‹æ‰¾æ¿Ÿå·å³¶é™å®šçš„ Hello Kitty å•†å“ã€‚</li>
                        </ul>`,
                    key: 'HK-Island-2025'
                },
                'ç†Ÿæˆåˆ° æ¶¯æœˆåº—': {
                    guide: `ç†Ÿæˆåˆ° (Sukseongdo) æ˜¯æ¿Ÿå·å³¶çŸ¥åçš„é»‘è±¬è‚‰é¤å»³ï¼Œä¸»æ‰“æ¿•å¼ç†Ÿæˆçš„é ‚ç´šè‚‰å“ã€‚é€™è£¡ç¶“å¸¸å®¢æ»¿ï¼Œå¼·çƒˆå»ºè­°æå‰é ç´„ï¼Œå¦å‰‡å¯èƒ½éœ€è¦ç­‰å¾…æ•¸å°æ™‚ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é»èœå–®</span>ï¼šç†Ÿæˆé»‘è±¬è‚‰äº”èŠ±è‚‰ï¼ˆì˜¤ê²¹ì‚´ï¼‰ï¼Œæ²¹è„‚è±å¯Œï¼Œå…¥å£å³åŒ–ã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">é‡è¦æé†’</span>ï¼šé€™é “æ˜¯æ™šé¤ï¼Œè«‹ç¢ºä¿åœ¨é ç´„æ™‚é–“å…§æŠµé”ï¼</li>
                        </ul>`,
                    key: 'Sukseongdo-Aewol-2025'
                },
                'Poniente æ°‘å®¿': {
                    guide: `Poniente ä½æ–¼æ¶¯æœˆï¼Œæ˜¯ä¸€å€‹éå¸¸èˆ’é©çš„ä½å®¿é¸æ“‡ã€‚è«‹æ³¨æ„ï¼Œå…¥ä½æ™‚é–“ç‚ºæ™šä¸Š 20:30ã€‚å»ºè­°åœ¨ç”¨é¤å¾Œå†å‰å¾€è¾¦ç†å…¥ä½æ‰‹çºŒï¼Œä»¥å…è€½èª¤æ™‚é–“ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full">é‡è¦æé†’</span>ï¼šæ™šé–“å…¥ä½è«‹æå‰èˆ‡æ°‘å®¿ä¸»äººç¢ºèª Check-in æ–¹å¼ã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">æ°‘å®¿åœ°å€</span>ï¼šè«‹æº–å‚™å¥½æ°‘å®¿çš„ç¢ºåˆ‡åœ°å€ç”¨æ–¼å°èˆªã€‚</li>
                        </ul>`,
                    key: 'Poniente-Checkin-2025'
                },
                'è¥¿æ­¸æµ¦æ¯æ—¥å¶ä¾†å¸‚å ´': {
                    guide: `è¥¿æ­¸æµ¦å¶ä¾†å¸‚å ´æ˜¯ä¸€å€‹å……æ»¿æ´»åŠ›çš„å‚³çµ±å¸‚å ´ï¼Œä¸åƒ…æ˜¯ç•¶åœ°å±…æ°‘çš„å»šæˆ¿ï¼Œä¹Ÿæ˜¯éŠå®¢é«”é©—æ¿Ÿå·ç¾é£Ÿçš„å¥½å»è™•ã€‚é€™è£¡æœ‰è¨±å¤šè²©å”®æ©˜å­å’Œæ©˜å­åŠ å·¥å“çš„æ”¤ä½ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…åƒç¾é£Ÿ</span>ï¼šç‚¸é›å¡Šä¸²ã€é»‘è±¬è‚‰å¯æ¨‚é¤…ã€è€å¥¶å¥¶æ©˜å­éº»ç³¬ã€‚</li>
                            <li><span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…è²·ä¼´æ‰‹ç¦®</span>ï¼šç•¶å­£æ¿Ÿå·æ©˜å­ã€æ©˜å­å·§å…‹åŠ›ã€å¸‚å ´è‡ªè£½çš„æ©˜å­é†¬ã€‚</li>
                        </ul>`,
                    key: 'Seogwipo-Market-2025'
                },
                'åŸå±±æ—¥å‡ºå³°': {
                    guide: `åŸå±±æ—¥å‡ºå³° (Seongsan Ilchulbong) æ˜¯ä¸€åº§å·¨å¤§çš„ç«å±±å£ï¼Œè¢«è¯åˆåœ‹æ•™ç§‘æ–‡çµ„ç¹”åˆ—ç‚ºä¸–ç•Œè‡ªç„¶éºç”¢ã€‚å¾å±±é ‚ä¿¯ç°çš„æ™¯è‰²å£¯éº—ç„¡æ¯”ï¼Œç‰¹åˆ¥æ˜¯æ—¥å‡ºæˆ–æ—¥è½æ™‚åˆ†ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded-full">é‡è¦æé†’</span>ï¼šä¸Šå±±ä¾†å›ç´„éœ€1å°æ™‚ï¼Œè«‹ç©¿è‘—èˆ’é©çš„é‹å­ï¼Œä¸¦è¨ˆç®—å¥½æ—¥è½æ™‚é–“ã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">æ—¥è½æ™‚é–“</span>ï¼šä»Šæ—¥é è¨ˆç´„ 17:15 å·¦å³ã€‚</li>
                        </ul>`,
                    key: 'Seongsan-Ilchulbong-2025'
                },
                'æ©˜èŠ±é–¨æ¨“': {
                    guide: `æ©˜èŠ±é–¨æ¨“æ˜¯ä¸€å®¶ä»¥æ¿Ÿå·æ©˜å­ç‚ºä¸»é¡Œçš„å’–å•¡å»³ï¼Œä»¥çµ•ç¾çš„çª—æ™¯èåï¼Œéå¸¸é©åˆæ‹ç…§ã€‚ç‰¹åˆ¥æ˜¯åœ¨ä¸‹é›¨å¤©ï¼Œå®¤å…§æ°›åœæ›´åŠ æº«é¦¨èˆ’é©ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é»</span>ï¼šæ©˜å­ç³»åˆ—é£²å“ã€æ©˜å­å¡”æˆ–è›‹ç³•ã€‚</li>
                            <li><span class="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…æ‹è§’åº¦</span>ï¼šååœ¨çª—é‚Šï¼Œä»¥æ©˜å­åœ’æˆ–æµ·æ™¯ç‚ºèƒŒæ™¯æ‹æ”ã€‚</li>
                        </ul>`,
                    key: 'Tangerine-Cafe-2025'
                },
                // --- æ›´æ–°ï¼šæ¿Ÿå·æ±é–€å¸‚å ´ ---
                'æ¿Ÿå·æ±é–€å¸‚å ´': {
                    guide: `æ¿Ÿå·æ±é–€å¸‚å ´æ˜¯æ¿Ÿå·å¸‚æœ€å¤§çš„å‚³çµ±å¸‚å ´ä¹‹ä¸€ï¼Œå¤œå¸‚éƒ¨åˆ†éå¸¸ç†±é¬§ï¼Œå°¤å…¶ä»¥æµ·é®®å’Œè¡—é ­å°åƒèåã€‚æ™šä¸Šä¾†é€™è£¡å¯ä»¥å¤§é£½å£ç¦ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¤œå¸‚å¿…åƒ</span>ï¼šé»‘è±¬è‚‰ä¸²ã€æ–°é®®ç”Ÿé­šç‰‡ã€çƒ¤æµ·é®®ã€å„ç¨®éŸ“å¼è¡—é ­å°åƒã€‚</li>
                            <li><span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded-full">å»ºè­°</span>ï¼šå¸‚å ´å…§æœ‰å¾ˆå¤šæ©˜å­ã€æ¼¢æ‹å³°æŸ‘æ©˜ç­‰ï¼Œé©åˆè³¼è²·ç•¶å­£æ°´æœã€‚</li>
                        </ul>`,
                    key: 'Dongmun-Market-2025'
                },
                'London Bagel & å¤¢ç‚­': {
                    guide: `é€™æ˜¯æ¿Ÿå·å³¶çŸ¥åçš„æ—©åˆé¤æ”»ç•¥çµ„åˆã€‚London Bagel æä¾›å„ç¨®ç¾å‘³çš„è²æœï¼›å¤¢ç‚­å‰‡æ˜¯å¦ä¸€å®¶å—æ­¡è¿çš„æ—©åˆé¤é»ï¼Œå¯èƒ½éœ€è¦æ’éšŠã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded-full">é‡è¦æé†’</span>ï¼šè«‹æå‰è¦åŠƒæ’éšŠæˆ–ç­‰å¾…æ™‚é–“ï¼Œå»ºè­°åœ¨ç‡Ÿæ¥­å‰æŠµé”ã€‚</li>
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é»</span>ï¼šè²æœæ­é…æ¿ƒéƒå¥¶æ²¹ä¹³é…ªï¼</li>
                        </ul>`,
                    key: 'Brunch-2025'
                },
                // --- æ›´æ–°ï¼šSnoopy Garden ---
                'Snoopy Garden ìŠ¤ëˆ„í”¼ê°€ë“ ': {
                    guide: `Snoopy Garden (å²åŠªæ¯”èŠ±åœ’) æˆ¶å¤–èŠ±åœ’ä½”åœ°å»£å¤§ï¼Œå®Œç¾å‘ˆç¾äº†ã€ŠèŠ±ç”Ÿæ¼«ç•«ã€‹ä¸­çš„å„ç¨®å ´æ™¯ã€‚ç„¡è«–å®¤å…§å®¤å¤–ï¼Œéƒ½æ˜¯å²åŠªæ¯”ç²‰çµ²å¿…è¨ªä¹‹åœ°ã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…æ‹è§’åº¦</span>ï¼šæˆ¶å¤–èŠ±åœ’è£¡çš„å„ç¨®å²åŠªæ¯”è£ç½®è—è¡“ï¼Œå»ºè­°é ç•™å……è¶³æ™‚é–“åœ¨æˆ¶å¤–ã€‚</li>
                            <li><span class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded-full">å»ºè­°</span>ï¼šåƒè§€çµæŸå¾Œï¼Œåˆ¥å¿˜äº†å»å’–å•¡å»³è³¼è²·è¯åå’–å•¡å’Œç´€å¿µå“ã€‚</li>
                        </ul>`,
                    key: 'Snoopy-Garden-2025'
                },
                'Puradak ç‚¸é›': {
                    guide: `Puradak ç‚¸é›æ˜¯éŸ“åœ‹çŸ¥åçš„é€£é–ç‚¸é›åº—ï¼Œä»¥å…¶ç‰¹åˆ¥çš„çƒ¤ç®±çƒ˜çƒ¤å¾Œå†æ²¹ç‚¸çš„æ–¹å¼ï¼Œæä¾›å¤–é…¥å…§å«©çš„å£æ„Ÿã€‚
                        <p class="mt-2 text-sm text-gray-700">ã€æ”»ç•¥æç¤ºã€‘</p>
                        <ul class="list-disc list-inside space-y-1 mt-1">
                            <li><span class="inline-block bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded-full">å¿…é»</span>ï¼šç´«èœæµ·è‹”å£å‘³ï¼ˆBlack Labelï¼‰ï¼Œé€™æ˜¯ä»–å€‘çš„æ‹›ç‰Œä¹‹ä¸€ã€‚</li>
                            <li><span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-0.5 rounded-full">å»ºè­°æ­é…</span>ï¼šå†°é®çš„å•¤é…’æˆ–å¯æ¨‚ï¼Œäº«å—å®Œç¾çš„éŸ“å¼å®µå¤œã€‚</li>
                        </ul>`,
                    key: 'Puradak-Chicken-2025'
                },
                default: {
                    guide: `ã€${locationName} å°è¦½åˆ†æã€‘<p class="text-xs italic mt-1 text-gray-400">ï¼ˆæ­¤ç‚ºé€šç”¨æ¨¡æ“¬å…§å®¹ã€‚è‹¥æœ‰ç‰¹å®šç¾é£Ÿ/ä¼´æ‰‹ç¦®/ä»£è™Ÿï¼Œç³»çµ±æœƒè‡ªå‹•äº®é¡¯ï¼‰</p>ï¼Œé€™æ˜¯ä¸€å€‹å€¼å¾—æ¢ç´¢çš„å¥½åœ°æ–¹ï¼åˆ¥å¿˜äº†æ‹ç…§ç•™å¿µï¼Œä¸¦äº«å—é€™é›£å¾—çš„æ™‚å…‰ã€‚`,
                    key: 'Default-Guide-2025'
                }
            };
            return nameToContent[locationName] || nameToContent.default;
        }

        async function fetchGuideDetails(dayKey, index) {
            const key = `${dayKey}-${index}`;
            const targetElement = document.getElementById(`guide-${key}`);
            const locationName = window.state.itineraryData[dayKey].locations[index].name;

            // ç·©å­˜å’Œæ”¶èµ·é‚è¼¯
            if (window.state.guideCache[key]) {
                const currentContent = window.state.guideCache[key];
                if (targetElement.innerHTML.includes('ã€æ”»ç•¥æç¤ºã€‘') || targetElement.innerHTML.includes('ï¼ˆæ­¤ç‚ºé€šç”¨æ¨¡æ“¬å…§å®¹')) {
                    targetElement.innerHTML = '<div class="text-sm text-gray-500 italic">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç²å–å°è¦½è³‡è¨Š...</div>';
                } else {
                    targetElement.innerHTML = currentContent;
                }
                // é‡æ–°æ¸²æŸ“å¡ç‰‡ä»¥æ›´æ–°æŒ‰éˆ•æ–‡å­—
                window.renderDailyItinerary(window.state.activePage);
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            targetElement.innerHTML = '<div class="text-sm text-primary-blue flex items-center"><svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> AI å°éŠåˆ†æä¸­...</div>';

            await new Promise(resolve => setTimeout(resolve, 1500));

            const { guide, key: guideKey } = getMockGuideContent(locationName);

            window.state.guideCache[key] = guide;
            targetElement.innerHTML = guide;

            window.renderDailyItinerary(window.state.activePage);
        }

        // --- åˆ†å¸³/è²»ç”¨åŠŸèƒ½æ¸²æŸ“ (ä¸è®Š) ---

        window.renderExpensePage = () => {
            const contentContainer = document.getElementById('content-container');
            contentContainer.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-lg mb-4">
                    <h2 class="text-2xl font-bold text-primary-blue mb-4">åˆ†å¸³ç´€éŒ„èˆ‡çµç®—</h2>
                    
                    <!-- åŒ¯ç‡æ›ç®—èˆ‡æ–°å¢è¡¨å–® -->
                    <form id="expense-form" class="space-y-4 border-b pb-4 mb-4">
                        <h3 class="text-xl font-bold text-gray-800">æ–°å¢è²»ç”¨</h3>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">é …ç›®æè¿°:</label>
                            <input type="text" id="description" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue p-2">
                        </div>

                        <div>
                            <label for="payer" class="block text-sm font-medium text-gray-700">èª°ä»˜çš„éŒ¢ (ä»˜æ¬¾äºº):</label>
                            <select id="payer" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue p-2">
                                <option value="" disabled selected>-- è«‹é¸æ“‡äººå“¡ --</option>
                                ${USERS.map(user => `<option value="${user}">${user}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label for="krwAmount" class="block text-sm font-medium text-gray-700">éŸ“å…ƒé‡‘é¡ (KRW):</label>
                            <input type="number" id="krwAmount" required class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue p-2" min="1">
                        </div>

                        <div id="twd-conversion" class="text-lg font-semibold text-green-600 bg-green-50 p-3 rounded-lg text-center">
                            â‰ˆ 0 TWD (åŒ¯ç‡: 1 KRW â‰ˆ ${KRW_TO_TWD_RATE.toFixed(3)} TWD)
                        </div>

                        <button type="submit" class="w-full bg-primary-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-150">
                            æ–°å¢è²»ç”¨ (4äººå¹³å‡åˆ†æ”¤)
                        </button>
                    </form>

                    <!-- åˆ†å¸³ç¸½çµå€å¡Š -->
                    <div id="expense-summary" class="mb-6">
                        <!-- Summary will be rendered here -->
                    </div>

                    <!-- è²»ç”¨æ¸…å–® -->
                    <div>
                        <h3 class="text-xl font-bold mb-3 text-gray-800">è²»ç”¨æ˜ç´°</h3>
                        <div id="expense-list" class="space-y-2">
                            <p class="text-center text-gray-500">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                </div>
            `;

            // é‡æ–°ç¶å®šäº‹ä»¶
            document.getElementById('krwAmount').addEventListener('input', updateTwdConversion);
            document.getElementById('expense-form').addEventListener('submit', handleExpenseSubmit);
            
            // æ¸²æŸ“åˆ—è¡¨å’Œç¸½çµ
            window.renderExpenseSummary();
            window.renderExpenseList();
        };

        // åŒ¯ç‡æ›ç®—å³æ™‚æ›´æ–° (ä¸è®Š)
        function updateTwdConversion() {
            const krw = parseFloat(document.getElementById('krwAmount').value) || 0;
            const twd = krw * KRW_TO_TWD_RATE;
            document.getElementById('twd-conversion').innerHTML = `
                â‰ˆ ${twd.toFixed(2)} TWD 
                <span class="text-xs font-normal opacity-75">(åŒ¯ç‡: 1 KRW â‰ˆ ${KRW_TO_TWD_RATE.toFixed(3)} TWD)</span>
            `;
        }
        
        // è²»ç”¨å„²å­˜è™•ç† (ä¸è®Š)
        async function handleExpenseSubmit(e) {
            e.preventDefault();
            const krwAmount = parseFloat(document.getElementById('krwAmount').value);
            const description = document.getElementById('description').value.trim();
            const payer = document.getElementById('payer').value;

            if (!krwAmount || !description || !payer) return;

            const twdAmount = krwAmount * KRW_TO_TWD_RATE;

            const newExpense = {
                krw: krwAmount,
                twd: twdAmount,
                description: description,
                payer: payer, // æ–°å¢ä»˜æ¬¾äºº
                userId: window.state.userId,
            };

            const success = await window.saveExpense(newExpense);
            if (success) {
                document.getElementById('expense-form').reset();
                document.getElementById('twd-conversion').innerHTML = `â‰ˆ 0 TWD (åŒ¯ç‡: 1 KRW â‰ˆ ${KRW_TO_TWD_RATE.toFixed(3)} TWD)`;
            }
        }

        // åˆ†å¸³é‚è¼¯è¨ˆç®— (ä¸è®Š)
        function calculateSplit(expenses) {
            if (expenses.length === 0) {
                return { totalTWD: 0, totalKRW: 0, summary: {} };
            }

            const totalTWD = expenses.reduce((sum, exp) => sum + exp.twd, 0);
            const sharePerPerson = totalTWD / USERS.length;
            const summary = {};

            USERS.forEach(user => {
                const twdPaid = expenses
                    .filter(exp => exp.payer === user)
                    .reduce((sum, exp) => sum + exp.twd, 0);

                const balance = twdPaid - sharePerPerson; // æ­£æ•¸ï¼šæ‡‰æ”¶å› / è² æ•¸ï¼šæ‡‰æ”¯ä»˜

                summary[user] = {
                    paid: twdPaid,
                    share: sharePerPerson,
                    balance: balance,
                    status: balance > 0.1 ? 'æ‡‰æ”¶å›' : (balance < -0.1 ? 'æ‡‰æ”¯ä»˜' : 'å·²çµæ¸…')
                };
            });

            return {
                totalTWD: totalTWD,
                totalKRW: expenses.reduce((sum, exp) => sum + exp.krw, 0),
                summary: summary,
                sharePerPerson: sharePerPerson
            };
        }

        // æ¸²æŸ“è²»ç”¨ç¸½çµ (ä¸è®Š)
        window.renderExpenseSummary = () => {
            const summaryContainer = document.getElementById('expense-summary');
            const { totalTWD, totalKRW, summary, sharePerPerson } = calculateSplit(window.state.expenses);

            if (!summaryContainer) return;

            if (window.state.expenses.length === 0) {
                summaryContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-3">åˆ†å¸³ç¸½çµ (4äºº)</h3>
                    <div class="bg-gray-100 p-4 rounded-lg text-center text-gray-500">
                        ç›®å‰ç„¡è²»ç”¨ç´€éŒ„ï¼Œç„¡éœ€çµç®—ã€‚
                    </div>
                `;
                return;
            }

            let summaryHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex justify-between items-center">
                    åˆ†å¸³ç¸½çµ (4äºº)
                    <span class="text-sm font-normal text-primary-blue bg-blue-100 px-2 py-1 rounded-full">ç¸½æ”¯å‡º: NT$ ${totalTWD.toFixed(0)}</span>
                </h3>
                <div class="bg-primary-blue text-white p-3 rounded-t-lg shadow-inner flex justify-between font-bold">
                    <span>æ¯äººæ‡‰åˆ†æ”¤:</span>
                    <span>NT$ ${sharePerPerson.toFixed(0)}</span>
                </div>
                <div class="bg-white border border-gray-200 rounded-b-lg divide-y divide-gray-100">
            `;

            USERS.forEach(user => {
                const userSummary = summary[user];
                const balanceClass = userSummary.balance > 0.1 ? 'text-red-500 font-bold' : (userSummary.balance < -0.1 ? 'text-green-500 font-bold' : 'text-gray-500');
                const sign = userSummary.balance > 0.1 ? '+$' : (userSummary.balance < -0.1 ? '-$' : 'Â±$');
                
                summaryHtml += `
                    <div class="p-3 flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${user}</p>
                            <p class="text-xs text-gray-500">å·²ä»˜: NT$ ${userSummary.paid.toFixed(0)}</p>
                        </div>
                        <div class="${balanceClass} text-lg text-right">
                            ${sign} ${Math.abs(userSummary.balance).toFixed(0)}
                            <p class="text-xs font-normal ${balanceClass}">${userSummary.status}</p>
                        </div>
                    </div>
                `;
            });

            summaryHtml += '</div>';
            summaryContainer.innerHTML = summaryHtml;
        };

        // æ¸²æŸ“è²»ç”¨æ¸…å–® (ä¸è®Š)
        window.renderExpenseList = () => {
            const list = document.getElementById('expense-list');
            if (!list) return; // ç¢ºä¿åœ¨åˆ†é ä¸Š
            
            const expenses = window.state.expenses;
            list.innerHTML = '';

            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰è¨˜éŒ„ä»»ä½•è²»ç”¨ã€‚</p>';
                return;
            }

            expenses.forEach(expense => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-900">${expense.description}</p>
                        <p class="text-sm text-gray-500">ä»˜æ¬¾äºº: ${expense.payer} | ${expense.krw.toLocaleString('ko-KR')} KRW</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-bold text-green-600">NT$ ${expense.twd.toFixed(0)}</p>
                        <button onclick="window.deleteExpense('${expense.id}')" class="text-red-400 hover:text-red-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        };
    </script>
</body>
</html>
